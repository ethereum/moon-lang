pragma solidity ^0.4.0;

// This allows stakeholders to approve an IPFS hash, and can return the
// weighted sum of ether that approved it. Used for rank & anti-phishing.

contract HashRank {
  // Who approved this hash
  mapping (bytes => address[]) approved;
  
  // Approves a hash
  function approve(bytes doc) public {
    approved[doc].push(msg.sender);
  }
  
  // Computes the rank (eth-weighted sum of approvals) of the document at index
  function rankOf(bytes doc) public constant returns (uint256) {
    uint256 rank = 0;
    
    uint256 len = approved[doc].length;
    for (uint256 i = 0; i < len; ++i) { 
      address voter = approved[doc][i];
        
      // Checks if voter already voted
      // FIXME: this would be less stupid with an in-memory map, but how?
      bool voted = false;
      for (uint256 j = 0; j < i; ++j) {
        voted = voted || approved[doc][j] == voter;
      }
      
      if (!voted) {
        rank += voter.balance;
      }
    }
    return rank;
  }
}

// 0.4.18+commit.9cf6e910.Emscripten.clang
// 6060604052341561000f57600080fd5b61044d8061001e6000396000f30060606040526004361061004b5763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663019d27298114610050578063a49ea0ab146100a3575b600080fd5b341561005b57600080fd5b6100a160046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284375094965061010695505050505050565b005b34156100ae57600080fd5b6100f460046024813581810190830135806020601f820181900481020160405190810160405281815292919060208401838380828437509496506101be95505050505050565b60405190815260200160405180910390f35b6000816040518082805190602001908083835b602083106101385780518252601f199092019160209182019101610119565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405190819003902080546001810161017c83826103d7565b506000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff19163373ffffffffffffffffffffffffffffffffffffffff1617905550565b600080808080808080886040518082805190602001908083835b602083106101f75780518252601f1990920191602091820191016101d8565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051908190039020549450600093505b848410156103cb576000886040518082805190602001908083835b6020831061026d5780518252601f19909201916020918201910161024e565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020848154811015156102ad57fe5b600091825260208220015473ffffffffffffffffffffffffffffffffffffffff16935091508190505b8381101561039c57818061039257508273ffffffffffffffffffffffffffffffffffffffff166000896040518082805190602001908083835b6020831061032e5780518252601f19909201916020918201910161030f565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208281548110151561036e57fe5b60009182526020909120015473ffffffffffffffffffffffffffffffffffffffff16145b91506001016102d6565b8115156103c0578273ffffffffffffffffffffffffffffffffffffffff1631860195505b836001019350610233565b50939695505050505050565b8154818355818115116103fb576000838152602090206103fb918101908301610400565b505050565b61041e91905b8082111561041a5760008155600101610406565b5090565b905600a165627a7a72305820f9f57db1fbdbb7aa19ba85544d8ea2be9fc5d3b71d11e7eac90d363c29c073060029
// [{"constant":false,"inputs":[{"name":"doc","type":"bytes"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"doc","type":"bytes"}],"name":"rankOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]
